{% extends "base.html" %}

{% block title %}加班系统{% endblock %}

{% block content %} 
    <div class="box">
      <div id="new_app">{% if "overtime.add_application" in request.user.get_group_permissions %}<a class="linkbutton" href="{% url new_overtime %}">新增加班申请</a>{% endif %}</div>
      <div id="app-list-title" class="clear">
        <div class="float_right">
          <span id="date_filter" onclick="showDatePicker();">时间范围：2012年</span>
        </div>
        <h2>加班列表</h2>
      </div>
      {% if "overtime.filter_application" in request.user.get_group_permissions %}
      <div id="app_filter">
        <ul>
          <li><a class="{% ifequal filter 'all' %}filterbutton-selected{% else %}filterbutton{% endifequal %}" href="{% url filter_all_overtime %}">全部</a></li>
          <li><a class="{% ifequal filter 'new' %}filterbutton-selected{% else %}filterbutton{% endifequal %}" href="{% url filter_new_overtime %}">未提交</a></li>
          <li><a class="{% ifequal filter 'applying' %}filterbutton-selected{% else %}filterbutton{% endifequal %}" href="{% url filter_applying_overtime %}">申请中</a></li>
          <li><a class="{% ifequal filter 'approved' %}filterbutton-selected{% else %}filterbutton{% endifequal %}" href="{% url filter_approved_overtime %}">通过</a></li>
        </ul>
      </div>
      {% endif %}
      <hr class="no-margin">
      <div class="todos">
        <ul>
        {% if is_hr %}
          {% for app in applications %}
              <li>
                  <h3><a href="{% url show_overtime app.id %}">{{ app.subject }}</a></h3>
                  {{ app.state }}
                  <div class="foot">最后由 • <span class="field">{{ app.modified_by.userprofile.chinese_name }}</span> • 于 • <span class="field">{{ app.modified_on|date:"Y年n月j日 H:i" }}</span> • 修改</div>
              </li>
          {% endfor %}
        {% else %}
          {% for flow in application_flows %}
              <li>
                <div id="app_title">
                  <h3><a href="{% url show_overtime flow.application.id %}">{{ flow.application.subject }}</a></h3>
                  <span class="roundblock_{{ flow.application.state.code }}" id="app_state">{{ flow.application.state }}</span>
                </div>
                <div class="foot">最后由 • <span class="field">{{ flow.application.modified_by.userprofile.chinese_name }}</span> • 于 • <span class="field">{{ flow.application.modified_on|date:"Y年n月j日 H:i" }}</span> • 修改</div>
                <div class="action">
                  {% if flow.can_update %}<a class="linkbutton" href="{% url edit_overtime flow.application.id %}">修改</a>{% endif %}
                  {% if flow.can_approve %}<a class="linkbutton" href="{% url approve_overtime flow.application.id %}">通过</a>{% endif %}
                  {% if flow.can_reject %}<a class="linkbutton" href="{% url reject_overtime flow.application.id %}">拒绝</a>{% endif %}
                  {% if flow.can_apply %}<a class="linkbutton" href="{% url apply_overtime flow.application.id %}">提交</a>{% endif %}
                  {% if flow.can_revoke %}<a class="linkbutton" href="{% url revoke_overtime flow.application.id %}">撤销</a>{% endif %}
                  {% if flow.can_delete %}<a class="linkbutton" href="{% url delete_overtime flow.application.id %}" onclick="return confirm('删除以后不能恢复的，确定？')">删除</a>{% endif %}
                </div>
              </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>        
    

    	
    <div id="dialog-date-filter" title="选择时间范围">
      <form id="date-filter-form" action="{% url filter_date_overtime %}">
        <p>
          <select id="quickDateRanges" onchange="changeDate();"> 							
            <option disabled="disabled" value="0">选择预设</option> 							
            <optgroup class="quick" label="预置日期"> 							
              <option value="1">今天</option>
              <option value="2">昨天</option>
              <option value="3">本周</option>
              <option value="4">上周</option>
              <option value="5">本月</option>
              <option value="6">上月</option>
              <option value="7">今年</option>
              <option value="8">去年</option>
            </optgroup>
        	</select>
      	</p><br>
        <p>
          <label for="date_from">从</label>
          <input type="text" id="date_from" name="date_from"/>
        </p>
        <p>
          <label for="date_to">到</label>
          <input type="text" id="date_to" name="date_to"/>
        </p>
      </form>
    </div>
    
    <script>
        $( "#date_from" ).datepicker({
        	defaultDate: "+1w",
        	changeMonth: true,
        	numberOfMonths: 3,
        	dateFormat: "yy-mm-dd",
        	onSelect: function( selectedDate ) {
        		$( "#date_to" ).datepicker( "option", "minDate", selectedDate );
        	}
        });
        $( "#date_to" ).datepicker({
        	defaultDate: "+1w",
        	changeMonth: true,
        	numberOfMonths: 3,
        	dateFormat: "yy-mm-dd",
        	onSelect: function( selectedDate ) {
        		$( "#date_from" ).datepicker( "option", "maxDate", selectedDate );
        	}
        });
        
        function fDate(date){
      	   if(!date.getDate()){return '';}
      	   var day = date.getDate();
      	   var month = date.getMonth();
      	   var year = date.getFullYear();
      	   month++; // adjust javascript month
      	   var dateFormat = 'yy-mm-dd';
      	   return jQuery.datepicker.formatDate( dateFormat, date ); 
      	}
      	
      	function changeDate() {
            switch($('#quickDateRanges').val()) {
              case '1':  //today
                $('#date_from').val(fDate(Date.now()));
                $('#date_to').val(fDate(Date.now()));
                break;
              case '2':  //yestoday
                $('#date_from').val(fDate(Date.parse('1 day ago')));
                $('#date_to').val(fDate(Date.parse('1 day ago')));
                break;
              case '3':  //this week
                break;
              case '4':  //last week
                break;
              case '5':  //this month
                break;
              case '6':  //last month
                $('#date_from').val(fDate(Date.parse('1 month ago').moveToFirstDayOfMonth()));
                $('#date_to').val(fDate(Date.parse('1 month ago').moveToLastDayOfMonth()));
                break;
              case '7':  //this year
                $('#date_from').val(fDate(Date.parse('1 month ago').moveToFirstDayOfMonth()));
                $('#date_to').val(fDate(Date.parse('1 month ago').moveToLastDayOfMonth()));
                break;
              case '8':  //last year
                $('#date_from').val(fDate(Date.parse('1 month ago').moveToFirstDayOfMonth()));
                $('#date_to').val(fDate(Date.parse('1 month ago').moveToLastDayOfMonth()));
                break;
            }
      	}

      	function showDatePicker() {
      		$( "#dialog-date-filter" ).dialog({
      			resizable: false,
      			draggable: false,
      			height:200,
      			width:300,
      			modal: true,
      			dialogClass: "alert",
      			buttons: {
      				"确定": function() {
                $("#date-filter-form").submit();
      					$( this ).dialog( "close" );
      				},
      				"取消": function() {
      					$( this ).dialog( "close" );
      				}
      			},
            open: function(event, ui) {
              $("#quickDateRanges").val(0);
            },
        	});
      	}
    </script>
{% endblock %}
